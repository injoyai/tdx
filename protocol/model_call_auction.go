package protocol

import (
	"errors"
	"time"

	"github.com/injoyai/logs"
)

type callAuction struct{}

/*
Frame
0c00000000011e001e006a05000030303030303100000000030000000000000000000000f4010000
*/
func (callAuction) Frame(code string) (*Frame, error) {
	exchange, number, err := DecodeCode(code)
	if err != nil {
		return nil, err
	}

	codeBs := []byte(number)
	codeBs = append(codeBs, []byte{
		0x00, 0x00, 0x00, 0x00,
		0x03, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00,
		0xf4, 0x01, 0x00, 0x00}...)
	return &Frame{
		Control: Control01,
		Type:    TypeCallAuction,
		Data:    append([]byte{exchange.Uint8(), 0x0}, codeBs...),
	}, nil
}

/*
Decode
54002b02cdcc3841340100001b00000000002b02ae473941d30800008c07000000092b02a47039411e0a00000f00000000122b02a4703941340a000013000000001b2b02ae473941510b00008707000000242b02ae473941510b00000f06000000362c02ae473941510b0000d706000000032c02ae473941600b00000d070000000c2c02ae473941600b00000e07000000152c02ae473941600b000027070000001e2c02ae473941890b00000e07000000272c02ae473941e00b0000bb06000000302c02ae473941e00b0000fd06000000392d02ae473941e30b00003707000000062d02ae473941480c0000d506000000182d02ae473941670c0000dc06000000212d02ae473941aa0c0000fd060000002a2d02ae473941aa0c0000b207000000332e02ae473941b10c0000c007000000002e02ae473941b20c00000508000000092e02ae473941bc0d00005f07000000122e02ae473941bc0d000062070000001b2e02ae473941ee0d00003007000000242e02ae473941ee0d00003d07000000362f02ae4739410a0e00002a07000000032f02ae4739410a0e00002f070000000c2f02ae4739410a0e0000c507000000152f02ae473941310d0000bc080000001e2f02ae4739411f0d00009d0b000000272f02ae4739413d0d0000850c000000302f02ae4739413d0d0000b90c000000393002ae4739413e0d0000c10c000000003002ae473941e0100000ed09000000093002ae47394155130000e20a000000123002ae473941fa130000450c0000001b3002ae473941fb1400002a0c000000243002ae4739416b150000e80b0000002d3002ae47394176150000520c000000363102ae47394177150000560c000000033102ae47394177150000490d0000000c3102ae47394177150000650d000000153102ae473941771500007e0d0000001e3102ae473941bd150000670e000000273102ae473941e41500004a0e000000303102ae4739414c160000ee0d000000393202ae473941581600002e0e000000063202ae4739410d1700009d0d0000000f3202ae473941481700008c0d000000183202ae4739418e170000cb0d000000213202ae473941961700000a0e0000002a3202ae4739411b180000b50d000000333302ae4739417b180000070e000000003302ae47394195180000180e000000093302ae4739419a180000910e000000123302ae473941e4180000540e0000001b3302ae473941181a0000920d000000243302ae4739413d1a0000a80e0000002d3302ae473941961b0000a70d000000363402ae473941081c0000fb0d000000033402a4703941cd1d00000f040000000c3402a4703941121e0000ef04000000153402a4703941181e000003060000001e3402a4703941f91e0000e808000000273402a4703941a11f00007d0b000000303402a4703941c91f0000221100000039810333333b4102030000c5b7ffff0009810333333b418d03000091b6ffff0012810333333b416a0500002db5ffff001b810333333b414809000070b7ffff0024810333333b419913000073bfffff002d810333333b41f31300003ebeffff0036820333333b4147140000d8bbffff0003820333333b417216000071bcffff000c820333333b41731a000096bcffff0015820333333b41941a000097b6ffff001e820333333b41201b00003db3ffff0027820333333b41611b00000db3ffff0030820333333b41c51b0000ebb1ffff003983033d0a3b419c20000081050000000683033d0a3b41f021000057060000000f83033d0a3b415d23000008050000001883033d0a3b418e250000e4020000002183033d0a3b41cc27000044010000002a83033d0a3b410b2b0000d7feffff0033
*/
func (callAuction) Decode(bs []byte) (*CallAuctionResp, error) {

	if len(bs) < 2 {
		return nil, errors.New("数据长度不足")
	}

	_count := Uint16(bs[:2])
	resp := &CallAuctionResp{
		Count: _count,
		List:  make([]*CallAuction, 0, _count),
	}

	bs = bs[2:]

	now := time.Now()
	for i := uint16(0); i < resp.Count; i++ {
		n := Uint16(bs[:2])
		_hour := int(n / 60)
		_minute := int(n % 60)
		_second := 0
		a := &CallAuction{}
		bs, a.Price = GetPrice(bs[2:6])
		bs, a.Match = CutInt(bs[6:])
		bs, a.Unmatched = CutInt(bs)
		bs = bs[1:]
		bs, _second = CutInt(bs)
		a.Time = time.Date(now.Year(), now.Month(), now.Day(), _hour, _minute, _second, 0, now.Location())
		resp.List = append(resp.List, a)
	}

	logs.Debug(len(bs))

	return resp, nil
}

type CallAuctionResp struct {
	Count uint16
	List  []*CallAuction
}

type CallAuction struct {
	Time      time.Time //时间
	Price     Price     //价格
	Match     int       //匹配量
	Unmatched int       //未匹配量
}
